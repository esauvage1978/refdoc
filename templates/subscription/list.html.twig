{% extends 'base.html.twig' %}

{% import "macros/widgets.html.twig" as widgets %}


{% block title %}{{ app_name }} - Abonnement{% endblock %}
{% block page_title %}{{ widgets.icon('subscription') }} Abonnement  {% if admin==true %} de {{ user.name }}{% endif %} {% endblock %}

{% block breadcrumb %}
    {% if admin==true %}
        {% import "user/actions.html.twig" as actions %}
        {{ actions.admin(
            'subscription',
            is_granted('ROLE_ADMIN'),
            user,
            'user'
        ) }}
    {% endif %}
{% endblock %}


{% block page_content %}

    <div class="row justify-content-center">
        

        {% embed 'widgets/card-widget.html.twig' %}
            {% import "macros/widgets.html.twig" as widgets %}
            {% block card_body_class %}p-0{% endblock %}
            {% block card_body %}
                <div class="list-group">

                    {% for  item in items %}
                        <a href="{{path('ajax_toogle_abonnement_mp',{id:item.id,'u_id':user.id})}}" 
                        class="list-group-item list-group-item-action a-animate  d-flex justify-content-between align-items-center js-subscription">
                            <span class='js-title mr-5'>   
                                {{ widgets.icon('mprocess') }}
                                {{ item.fullname | raw}}
                            </span>
                            <span class='js-toggle'>
                                <span class=' text-muted mr-1'></span>
                                {% if item in abosMP %} 
                                    <i class="fa fa-check text-success"></i>
                                    {% else %}
                                    <i class="fa fa-times text-warning"></i>
                                {% endif %}
                            </span>
                        </a>
                        {% for  p in item.processes %}
                            <a href="{{path('ajax_toogle_abonnement_p',{id:p.id,'u_id': user.id})}}"
                            class="list-group-item list-group-item-action a-animate  d-flex justify-content-between align-items-center js-subscription">
                                <span class='js-title mr-5 ml-5 text-sm'>   
                                    {{ widgets.icon('process') }}
                                    {{ p.fullname | raw}}
                                </span>
                                <span class='js-toggle'>
                                    <span class=' text-muted mr-1'></span>
                                    {% if p in abosP %} 
                                        <i class="fa fa-check text-success"></i>
                                        {% else %}
                                        <i class="fa fa-times text-warning"></i>
                                    {% endif %}
                                </span>
                            </a>
                        {% endfor %}
                    {% endfor %}

                </div>
            {% endblock %}
        {% endembed %}
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
        <script src="{{ absolute_url( asset('/vendor/axios/dist/axios.min.js')) }}"></script>
    <script>

        

        function onClickToggleSubscription(event){
            event.preventDefault();

            const url= this.href;
            const spanToggle = this.querySelector('span.js-toggle');
            const spanMessage = spanToggle.querySelector('span');
            const icone=spanToggle.querySelector('i');

            axios.get(url).then(function(response) {
                spanMessage.textContent = response.data.message;
                if(!response.data.value) {
                    icone.classList="fa fa-times text-warning";
                    spanMessage.classList="text-warning";
                } else {
                    icone.classList="fa fa-check text-success";
                    spanMessage.classList="text-success";
                }
            }).catch(function(error){
                if(error.response.status ===403) {
                    windows.alert('Vous n\'êtes pas connecté');
                } else {
                    windows.alert('Une erreur s\'est produite, merci de contacter l\'administrateur : ' . error.response.status);
                }

            })
        }


        document.querySelectorAll("a.js-subscription").forEach(function(link){
            link.addEventListener('click',onClickToggleSubscription);
        })

    </script>
{% endblock %}